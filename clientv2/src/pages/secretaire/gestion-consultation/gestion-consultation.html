<!-- start side bar -->
<app-side-bar [isOpen] = "isOpen"></app-side-bar>
<!-- end sidebar -->

<!-- start min top nav -->
<app-nav-bar (toggle)="isOpen = !isOpen"></app-nav-bar>
<!-- end min top nav -->

<!-- start main -->
<main [ngClass]="{'md:ml-64 md:w-[calc(100%-256px)]': isOpen, 'md:ml-0': !isOpen}" class="bg-gray-100 duration-500 w-full h-svh pt-16 overflow-y-scroll">
  <section class="p-4 mt-4 text-black">
      <div class="flex items-center justify-start gap-4 mt-3 mb-8">
          <i class="pi pi-users text-gray-500 shadow-lg rounded-lg text-3xl p-2 "></i>
          <h2 class="mb-2 text-3xl font-bold">gestion des consultations</h2>
      </div>

      <div class="rounded-xl bg-white p-4 mt-4">
        <div class="m-4">
          <p-button (onClick)="showCreateDialog()" label="créer consultation"  icon="pi pi-plus" iconPos="right" [raised]="true"  severity="info" class="mx-3"/>
        </div>
        <p-table
          [paginator]="true"
          [rows]="5"
          [value]="consultations"
          [loading]="consultationsLoading"
          stripedRows
          showGridlines
          [tableStyle]="{'min-width': '50rem'}">
          <ng-template #header>
            <tr>
              <th>id</th>
              <th>date debut</th>
              <th>date fin</th>
              <th>patient</th>
              <th>rendez-vous</th>
              <th>facture</th>
              <th>activité</th>
              <th>actions</th>
              <th>ordonnance</th>
            </tr>
          </ng-template>
          <ng-template #body let-consultation>
              <tr class="bg-white border-b">
                    <td class="px-6 py-4">{{consultation.id}}</td>
                    <td class="px-6 py-4">{{consultation.dateDebut}}</td>
                    <td class="px-6 py-4">{{consultation.dateFin}}</td>
                    <td class="px-6 py-4">{{consultation.patient.nom}} {{consultation.patient.prenom}}</td>
                    <td class="px-6 py-4">
                      @if (consultation.rdv) {
                        <p-button (onClick)="showRdvViewDialog(consultation.rdv)"  icon="pi pi-eye" [rounded]="true" [raised]="true"  severity="warn" class="mx-3"></p-button>
                      }@else {
                        <p-button (onClick)="showRdvCreateDialog(consultation.id)"  icon="pi pi-plus" [rounded]="true" [raised]="true"  severity="help" class="mx-3"></p-button>
                      }
                    </td>
                    <td class="px-6 py-4">
                      @if (consultation.facture) {
                        <p-button (onClick)="showFactureViewDialog(consultation.facture)"  icon="pi pi-eye" [rounded]="true" [raised]="true"  severity="warn" class="mx-3"></p-button>
                      }@else {
                        <p-button (onClick)="showFactureCreateDialog(consultation.id)"  icon="pi pi-plus" [rounded]="true" [raised]="true"  severity="help" class="mx-3"></p-button>
                      }
                    </td>
                    <!-- activite -->
                    <td>
                      <p-button (onClick)="showAddActivity(consultation.id)"  icon="pi pi-plus" [rounded]="true" [raised]="true"  severity="help" class="mx-3"></p-button>
                    </td>
                    <td class="px-6 py-4">
                        <!-- <p-button (onClick)="showCompte()"  icon="pi pi-eye" [rounded]="true" [raised]="true"></p-button> -->
                        <p-button (onClick)="showEditDialog(consultation)"  icon="pi pi-pencil" [rounded]="true" [raised]="true"  severity="info" class="mx-3"></p-button>
                        <p-button (onClick)="deleteConsultation(consultation.id)"  icon="pi pi-trash" [rounded]="true" [raised]="true"  severity="danger"></p-button>
                    </td>
                    <td class="px-6 py-4">
                      <p-button (onClick)="showOrdonanceDialog(consultation.id)"  icon="pi pi-file-export" [rounded]="true" [raised]="true"  severity="info" class="mx-3"></p-button>
                    </td>
              </tr>
          </ng-template>
        </p-table>
      </div>

  </section>

  <!-- consultation creat form popup -->
  <p-dialog header="créer un consultation" [modal]="true" [(visible)]="visible_create">
      <form [formGroup]="fg" (ngSubmit)="createConsultation()"  class="w-full p-4 border border-gray-300 bg-white" method="post">
          <div class="grid grid-cols-2 gap-5 text-black">
            <!-- date debut -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="">date debut</label>
              <input type="date" formControlName="dateDebut" name="dateDebut" class="block w-full p-2.5 text-sm bg-white border-gray-300 border rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <!-- date fin -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="">date fin</label>
              <input type="date" formControlName="dateFin" name="dateFin" class="block w-full p-2.5 text-sm bg-white border-gray-300 border rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <!-- type -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="">role</label>
              <select formControlName="typeId" name="typeId" class="w-full  mb-3 bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                @for (type of types; track type.id) {
                  <option [value]="type.id">{{type.libelle}}</option>
                }
              </select>
            </div>

            <!-- patient -->
            <div class="col-start-1 col-end-3">
              <h3 class="mb-1">choisi un patient</h3>

              <p-table
                  [paginator]="true"
                  [rows]="5"
                  [value]="patients"
                  [loading]="patientsLoading"
                  selectionMode="single"
                  [(selection)]="selectedPatient"
                  [metaKeySelection]="true"
                  dataKey="id"
                  stripedRows
                  showGridlines
                  [tableStyle]="{'min-width': '50rem'}">
                  <ng-template #header>
                      <tr>
                          <th>nom</th>
                          <th>prenom</th>
                          <th>sexe</th>
                          <th>date de naissance</th>
                          <th>cin</th>
                          <th>telephone</th>
                          <th>email</th>
                          <th>adresse</th>
                      </tr>
                  </ng-template>
                  <ng-template #body let-patient>
                      <tr [pSelectableRow]="patient" class="bg-white border-b">
                          <td class="px-6 py-4">{{patient.nom}}</td>
                          <td class="px-6 py-4">{{patient.prenom}}</td>
                          <td class="px-6 py-4">{{patient.sexe}}</td>
                          <td class="px-6 py-4">{{patient.dateNaissance}}</td>
                          <td class="px-6 py-4">{{patient.cin}}</td>
                          <td class="px-6 py-4">{{patient.telephone}}</td>
                          <td class="px-6 py-4">{{patient.email}}</td>
                          <td class="px-6 py-4">{{patient.adresse}}</td>
                      </tr>
                  </ng-template>
              </p-table>
            </div>
          </div>
          <button type="submit" class="w-full mt-5 rounded-md bg-blue-600 text-center py-3 text-white">
            créer consultation
          </button>
        </form>
  </p-dialog>

  <!-- rdv creat form popup -->
  <p-dialog header="créer rendez-vous" [modal]="true" [(visible)]="visible_rdv_create" [style]="{ width: '30rem' }">
      <form [formGroup]="rdv_fg" (ngSubmit)="createRdv()"  class="w-full p-4 border border-gray-300 bg-white" method="post">
          <div class="grid grid-cols-2 gap-5 text-black">
            <!-- motif -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="">motif</label>
              <input type="text" formControlName="motif" name="motif" class="block w-full p-2.5 text-sm bg-white border-gray-300 border rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <!-- date -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="">date</label>
              <input type="date" formControlName="date" name="date" class="block w-full p-2.5 text-sm bg-white border-gray-300 border rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <!-- statut -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="">statut</label>
              <select formControlName="statut" name="statut" class="w-full  mb-3 bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                  <option value="CONFIRME">Confirmé</option>
                  <option value="REPORTE">Reporté</option>
                  <option value="ANNULE">Annulé</option>
                  <option value="TERMINE">Terminé</option>>
              </select>
            </div>

          </div>
          <button type="submit" class="w-full mt-5 rounded-md bg-blue-600 text-center py-3 text-white">
            créer activité
          </button>
        </form>
  </p-dialog>

  <!-- facture create form popup -->
  <p-dialog header="créer facture" [modal]="true" [(visible)]="visible_facture_create" [style]="{ width: '30rem' }">
      <form [formGroup]="facture_fg" (ngSubmit)="createFacture()"  class="w-full p-4 border border-gray-300 bg-white">
          <div class="grid grid-cols-2 gap-5 text-black">
            <!-- date paiment -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="datePaiment">date paiment</label>
              <input type="date" formControlName="datePaiment" id="datePaiment" name="date" class="block w-full p-2.5 text-sm bg-white border-gray-300 border rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>


          </div>
          <button type="submit" class="w-full mt-5 rounded-md bg-blue-600 text-center py-3 text-white">
            modifier
          </button>
      </form>
  </p-dialog>

  <!-- consultation edit form popup -->
  <p-dialog header="modifier cette consultation" [modal]="true" [(visible)]="visible_edit" [style]="{ width: '30rem' }">
      <form [formGroup]="fg" (ngSubmit)="edit($event)"  class="w-full p-4 border border-gray-300 bg-white">
          <div class="grid grid-cols-2 gap-5 text-black">
            <!-- date debut -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="">date debut</label>
              <input type="date" formControlName="dateDebut" name="dateDebut" class="block w-full p-2.5 text-sm bg-white border-gray-300 border rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <!-- date fin -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="">date fin</label>
              <input type="date" formControlName="dateFin" name="dateFin" class="block w-full p-2.5 text-sm bg-white border-gray-300 border rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

          </div>
          <button type="submit" class="w-full mt-5 rounded-md bg-blue-600 text-center py-3 text-white">
            modifier
          </button>
        </form>
  </p-dialog>
  <!-- end compte edit form popup -->

  <!-- generate ordonance -->
  <p-dialog header="generation ordonnance" [modal]="true" [(visible)]="visible_generate" [style]="{ width: '40rem' }">
    <form [formGroup]="ordonnanceForm" (ngSubmit)="generateOrdonance()" class="w-full p-4 border border-gray-300 bg-white">
      <!-- Correction : formArrayName="medicamentsReq" au lieu de "medicamentsArray" -->
      <div formArrayName="req" class="grid grid-cols-1 gap-5 text-black">
        @for (medicament of medicamentsArray.controls; track $index; let i = $index) {
          <div class="bg-slate-200 p-3 rounded-md" [formGroupName]="i">
            <h3>Médicament {{ i + 1 }}</h3>

            <!-- Nom du médicament -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="nom">Nom du médicament</label>
              <input type="text" formControlName="nom" name="nom" class="block w-full p-2.5 text-sm bg-white border-gray-300 border rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <!-- dosage -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="dosage">Dosage</label>
              <input type="text" formControlName="dosage" name="dosage" placeholder="ex: 500mg" class="block w-full p-2.5 text-sm bg-white border-gray-300 border rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <!-- Forme -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="forme">Forme</label>
              <select formControlName="forme" name="forme" class="w-full mb-3 bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                <option value="Comprimé">Comprimé</option>
                <option value="Sirop">Sirop</option>
                <option value="Injection">Injection</option>
                <option value="Pommade">Pommade</option>
              </select>
            </div>

            <!-- posologie -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="posologie">Posologie</label>
              <input type="text" formControlName="posologie" name="posologie" placeholder="ex: 1 comprimé 3 fois par jour" class="block w-full p-2.5 text-sm bg-white border-gray-300 border rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <!-- Durée du traitement -->
            <div>
              <label class="block mb-2 text-sm font-medium" for="duree">Durée</label>
              <input type="text" formControlName="duree" name="duree" class="block w-full p-2.5 text-sm bg-white border-gray-300 border rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>
          </div>
        }
      </div>
      <button type="button" (click)="ajouterMedicament()" class="w-full mt-5 rounded-md bg-blue-600 text-center py-3 text-white">Ajouter un médicament</button>
      <button type="submit" class="w-full mt-5 rounded-md bg-blue-600 text-center py-3 text-white">Générer</button>
    </form>
  </p-dialog>

  <!-- dialog to view rdv -->
   @if (selectedRdv) {
     <p-dialog
         [header]="`Détails du rendez-vous | id_rendez-vous: ${selectedRdv.id}`"
         [modal]="true"
         [(visible)]="visible_rdv_view"
         [style]="{width: '450px'}"
         [draggable]="false"
         [resizable]="false"
         [breakpoints]="{ '960px': '75vw' }">

         <div class="grid grid-cols-2 gap-4 p-4">
             <!-- Labels -->
             <div class="flex flex-col gap-3 text-right pr-4 border-r border-gray-200">
                 <span class="font-semibold text-gray-700">Motif</span>
                 <span class="font-semibold text-gray-700">Statut</span>
                 <span class="font-semibold text-gray-700">Date</span>
             </div>

             <!-- Values -->
             <div class="flex flex-col gap-3 text-left pl-4">
                 <span class="text-gray-600">{{selectedRdv.motif}}</span>
                 <span class="text-gray-600">{{selectedRdv.statut}}</span>
                 <span class="text-gray-600">{{selectedRdv.date}}</span>
             </div>
         </div>
     </p-dialog>
   }

  <!-- dialog to view facture -->
   @if (selectedFacture) {
     <p-dialog
         [header]="`Détails du facture | id_facture: ${selectedFacture.id}`"
         [modal]="true"
         [(visible)]="visible_facture_view"
         [style]="{width: '450px'}"
         [draggable]="false"
         [resizable]="false"
         [breakpoints]="{ '960px': '75vw' }">

         <div class="grid grid-cols-2 gap-4 p-4">
             <!-- Labels -->
             <div class="flex flex-col gap-3 text-right pr-4 border-r border-gray-200">
                 <span class="font-semibold text-gray-700">montant</span>
                 <span class="font-semibold text-gray-700">Statut</span>
                 <span class="font-semibold text-gray-700">Date</span>
                 <span class="font-semibold text-gray-700">Consultation</span>
             </div>

             <!-- Values -->
             <div class="flex flex-col gap-3 text-left pl-4">
               <span class="text-gray-600">{{selectedFacture.montant}}</span>
               <span class="text-gray-600">{{selectedFacture.datePaiment}}</span>
               <span class="text-gray-600">{{selectedFacture.consultation.id}}</span>
             </div>
         </div>
     </p-dialog>
   }

  <p-dialog header="ajouter activité(s)" [modal]="true" [(visible)]="visible_activity">
    <form [formGroup]="add_activites_fg" (ngSubmit)="addActivites()"  class="w-full p-4 border border-gray-300 bg-white" method="post">
      <div class="grid grid-cols-2 gap-5 text-black">
        <!-- activities -->
        <div class="col-start-1 col-end-3">
          <h3 class="mb-1">choisi activite(s)</h3>

          <p-table
              [paginator]="true"
              [rows]="5"
              [value]="activities"
              selectionMode="multiple"
              [(selection)]="selectedActivites"
              [metaKeySelection]="true"
              dataKey="id"
              stripedRows
              showGridlines
              [tableStyle]="{'min-width': '50rem'}">
              <ng-template #header>
                  <tr>
                      <th>type</th>
                      <th>date</th>
                      <th>statut</th>
                  </tr>
              </ng-template>
              <ng-template #body let-activity>
                  <tr [pSelectableRow]="activity" class="bg-white border-b">
                      <td class="px-6 py-4">{{activity.type}}</td>
                      <td class="px-6 py-4">{{activity.date}}</td>
                      <td class="px-6 py-4">{{activity.statut}}</td>
                  </tr>
              </ng-template>
          </p-table>
        </div>
      </div>
      <button type="submit" class="w-full mt-5 rounded-md bg-blue-600 text-center py-3 text-white">
        ajouter
      </button>
    </form>
  </p-dialog>

  <p-toast />
  <p-confirmdialog />

</main>
<!-- end main -->
